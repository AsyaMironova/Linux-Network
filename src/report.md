# Сети в Linux 

Настройка сетей в Linux на виртуальных машинах.

## Part 1. Инструмент **ipcalc**

Устанавливаем ipcalc командой sudo apt install ipcalc
![sudo apt install ipcalc](png/ping1.1.png)

#### 1.1. Сети и маски

Чтобы получить всю интересующую нас информацию об адресе 192.167.38.54/13, воспользуемся командой ipcalc 192.167.38.54/13

![ipcalc 192.167.38.54/13](png/ping1.2.png)
##### 1) Адрес сети 
    Network: 192.160.0.0/13
##### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную
*   Перевод маски *255.255.255.0* в префиксную и двоичную запись
![ipcalc 255.255.255.0](png/ping1.3.png)
    1. В префиксную - /24
    2. Двоичная запись - 11111111.11111111.11111111.00000000
*  /15 в обычную и двоичную:
![ipcalc /15](png/ping1.4.png)
    1. Обычная запись - 255.254.0.0
    2. Двоичная запись - 11111111.11111110.00000000.00000000
* 11111111.11111111.11111111.11110000 в обычную и префиксную:
    1. В обычную - 255.255.255.240
    2. В префиксную - /28

##### 3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
* Маска /8:
![/8](png/ping1.5.png)
    1. HostMin: 12.0.0.1
    2. HostMax: 12.255.255.254
* Маска 11111111.11111111.00000000.00000000 (мы не можем указать двоичную форму адреса в качестве ввода ipcalc, поэтому используем маску /16):
![/16](png/ping1.6.png)
    1. HostMin: 12.167.0.1
    2. HostMax: 12.167.255.254
* Маска 255.255.254.0:
![/255.255.255.0](png/ping1.7.png)
    1. HostMin: 12.167.38.1
    2. HostMax: 12.167.39.254
* Маска /4:
![/4](png/ping1.8.png)
    1. HostMin: 0.0.0.1
    2. HostMax: 15.255.255.254

**1.2. localhost**

1. Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1:
    * 194.34.23.100 - нет
    * 127.0.0.2 - да
    * 127.1.0.1 - да
    * 128.0.0.1 - нет

**1.3. Диапазоны и сегменты сетей**

1. Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1:

    * 10.0.0.45 - частный
    * 134.43.0.2 - публичный
    * 192.168.4.2 - частный
    * 172.20.250.4 - частный
    * 172.0.2.1 - публичный
    * 192.172.0.1 - публичный
    * 172.68.0.2 - публичный
    * 172.16.255.255 - частный
    * 10.10.10.10 - частный
    * 192.169.168.1 - публичный


Вот общепринятые диапазоны для частных IP-адресов:
10.0.0.0 - 10.255.255.255 (диапазон A);
172.16.0.0 - 172.31.255.255 (диапазон B);
192.168.0.0 - 192.168.255.255 (диапазон C);

Из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255


## Part 2. Статическая маршрутизация между двумя машинами

##### Подними две виртуальные машины (далее -- ws1 и ws2).

Поднимаем две виртуальные машины и в настройках каждой указываем внутреннюю сеть. 

![alt text](png/ping2.1.png)
![alt text](png/ping2.2.png)

Запускаем обе машины и устанавливаем им соответствующие имена хоста:

для первой машины
sudo hostnamectl set-hostname ws1

для второй машины
sudo hostnamectl set-hostname ws2
 
1. С помощью команды `ip a` посмотреть существующие сетевые интерфейсы.
![ip a ws1](png/ping2.3.png)
![ip a ws2](png/ping2.4.png)

При выводе этой команды, можем увидеть 2 сетевых интерфейса lo (localhost), enp0s3.


##### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*.

С помощью следующей команды (аналогичная команда ip route или ip route) проверяем адреса машин
   >  netstat -nr
![netstat -nr](png/ping2.5.png)
- ` -n ` - отбражение адресов в числовом виде;
- ` -r ` - отображение в виде таблицы.
 *etc/netplan/00-installer-config.yaml* 

Этот файл на обеих машинах сначала выглядит одинаково

![ws1](png/ping2.6.png)
Дописываем в файлы соответствующие строки.
![ws1](png/ping2.7.png) 
![ws2](png/ping2.8.png)


##### Выполни команду `netplan apply` для перезапуска сервиса сети.
![ws1](png/ping2.9.png)

С помощью команды перепроверяем настройки ` ip a `

![ws1](png/ping2.11.png)
![ws2](png/ping2.10.png)

#### 2.1. Добавление статического маршрута вручную
> ` sudo ip route add 172.24.116.8 dev enp0s3 `
> ` sudo ip route add 192.168.100.0 dev enp0s3 `
![alt text](png/ping2.12.png)
![alt text](png/ping2.13.png)

##### Пропингуй соединение между машинами.

> ` ping -c 5 <IP-address> `

- ` -c ` - указывает количество пакетов.

> ` ping -c 5 172.24.116.8 `

![ping ws1](png/ping2.14.png)

> ` ping -c 5 192.168.100.10 `

![ping ws2](png/ping2.15.png)

#### 2.2. Добавление статического маршрута с сохранением

Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

- ws1
![ws1](png/ping2.16.png)

- ws2
![ws2](png/ping2.17.png)

Пропинговать соединение между машинами

- ws1
![ws1](png/ping2.18.png)

- ws2
![ws2](png/ping2.19.png)

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения

Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps = 1024 Mbps

#### 3.2 Утилита iperf3

Измерить скорость соединения между ws1 и ws2

- Запускаем ws1 в качестве сервера:
![iperf3 -s](png/ping3.1.png)

- Запускаем ws2 в качестве клиента:
![iperf3 -c 192.168.100.10](png/ping3.2.png)

## Part 4. Сетевой экран
#### 4.1. Утилита **iptables**
> Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:

![ws1](png/ping4.1.png)
![ws2](png/ping4.2.png)

> Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh

![ws1](png/ping4.3.png)
![ws2](png/ping4.4.png)

> Основная разница между этими стратегиями заключается в порядке применения запрещающих и разрешающих правил

- Разница между стратегиями заключается в том, что в первом файле первым подходящим правилом для пакета является запрет, а во втором - разрешение. Применяется только первое подходящее правило, остальные игнорируются.


#### 4.2. Утилита **nmap**

Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен

- ping с ws1 на ws2
![pingws1](png/ping4.5.png)
- ping с ws2 на ws1
![pingws2](png/ping4.6.png)

- nmap

![nmap](png/ping4.6.png)

## Part 5. Статическая маршрутизация сети

Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))


#### 5.1. Настройка адресов машин

Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

- ws11
![ws11](png/ping5.1.png)

- ws21
![ws21](png/ping5.2.png)

- ws22
![ws22](png/ping5.3.png)

- r1
![r1](png/ping5.4.png)

- r2
![r2](png/ping5.5.png)

Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

Для всех машин выполняем sudo netplan apply

- ping ws22 с ws21 и r1 c ws11
![ping ws22-ws21](png/ping5.10.png)
![ping r1-ws21](png/ping5.11.png)

#### 5.2. Включение переадресации IP-адресов.

Для включения переадресации IP, выполните команду на роутерах:

> sysctl -w net.ipv4.ip_forward=1 

При таком подходе переадресация не будет работать после перезагрузки системы.

- r1
![r1](png/ping5.12.png)

- r2 
![r2](png/ping5.13.png)

Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:

> net.ipv4.ip_forward = 1 

При использовании этого подхода, IP-переадресация включена на постоянной основе.

- r1
![r1](png/ping5.14.png)

- r2
![r2](png/ping5.15.png)

#### 5.3. Установка маршрута по-умолчанию
Пример вывода команды `ip r` после добавления шлюза:
```
default via 10.10.0.1 dev eth0
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2
```
##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций

- ws11
![5.16.jpg](png/ping5.16.png)

- ws21
![5.17.jpg](png/ping5.17.png)

- ws22
![5.30.jpg](png/ping5.30.png)

- r1
![5.31.jpg](png/ping5.31.png)

- r2
![5.32.jpg](png/ping5.32.png)

##### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации

- ws11

![ws11](png/ping5.18.png)

- ws21

![ws21](png/ping5.19.png)

- ws22

![ws22](png/ping5.20.png)


##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`

- пингуем с ws11, проверяем с помощью tcpdump -tn -i eth1

![ws11](png/ping5.21.png)

![r2](png/ping5.22.png)


#### 5.4. Добавление статических маршрутов
##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:

- Cтатические маршруты для r1 и r2 

![r1](png/ping5.23.png)
![r2](png/ping5.24.png)

##### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
```
10.100.0.0/16 dev eth1 proto kernel scope link src 10.100.0.11
10.20.0.0/26 via 10.100.0.12 dev eth1
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.1
```
- Вызов `ip r` для r1 и r2

![r1](png/ping5.25.png)

![r2](png/ping5.26.png)

##### Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![ws11](png/ping5.27.png)

- Маршруты, которые более точно соответствуют целевому IP-адресу, имеют более высокий приоритет. Если есть маршрут для конкретной подсети, он будте иметь более высокий приоритет, чем маршрут по умолчанию


#### 5.5. Построение списка маршрутизаторов


##### Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`

##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
- Вызов и вывод traceroute на ws11

![ws11](png/ping5.28.png)

- Принцип построения пути при помощи traceroute:  
Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа. Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше.  
Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i enp0s8 icmp`

![tcpdump -n -i enp0s8 icmp9](png/ping5.9.png)

##### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`
![ws11](png/ping5.29.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:

- изменения в файл /etc/dhcp/dhcpd.conf

![ /etc/dhcp/dhcpd.conf](png/ping6.1.png)

##### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![nameserver 8.8.8.8.](png/ping6.2.png)
##### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

- Перезагружаем службу DHCP
![службу DHCP)](png/ping6.3.png)

- Перезагружаю ws21 с помощью команды `sudo reboot` и вызываю команду `ip a` (ip получен)

![ws21](png/ping6.4.png)
- Пинг ws22 с ws21

![Пинг ws22 с ws21](png/ping6.5.png)

##### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`. Так же меняем MAC в настройках VB для ws11.

![MAC адрес у ws11)](png/ping6.6.png)

##### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

- Вношу изменения в файл /etc/dhcp/dhcpd.conf

- Редактируем файл /etc/resolv.conf и перезагружаем службу DHCP

![/etc/dhcp/dhcpd.conf](png/ping6.7.png)


- Перезагружаю ws11 с помощью команды sudo reboot и вызываю команду ip a (ip получен)

![sudo reboot](png/ping6.8.png)

##### Запросить с ws21 обновление ip адреса

- Проверяем IP до обновления
- Запросим с ws21 обновление ip адреса с помощью команды ``sudo dhclient -v``
    - v - будет выведена дополнительная информация.
- Проверяем IP после обновления

![6.11.jpg](6.11.jpg)

## Part 7. **NAT**
`-` Ну и, наконец, в качестве вишенки на торте, я расскажу тебе про механизм преобразования адресов.

**== Задание ==**

*В данном задании используются виртуальные машины из Части 5*
##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

- Для ws22 и r1 меняем `Listen 80` на `Listen 0.0.0.0:80`

![ws22](png/ping7.1.png)

![r1](png/ping7.2.png)


##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

- Запускаем веб-сервер Apache для r1

![r1](png/ping7.3.png)

- Запускаем веб-сервер Apache для ws22

![ws22](png/ping7.4.png)

##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) удаление правил в таблице filter - `iptables -F`
##### 2) удаление правил в таблице "NAT" - `iptables -F -t nat`
##### 3) отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

![r2](png/ping7.5.png)

##### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*

![r1](png/ping7.6.png)
![ws22](png/ping7.7.png)

##### Добавить в файл ещё одно правило:
##### 4) разрешить маршрутизацию всех пакетов протокола **ICMP**

![ICMP](png/ping7.8.png)

##### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*

![r1](png/ping7.9.png)
![ws22](png/ping7.10.png)

##### Добавить в файл ещё два правила:
##### 5) включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
##### 6) включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![Добавить в файл ещё два правила](png/ping7.11.png)


##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`

- Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:
- Проверка соединения по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080):

![r1](png/ping7.12.png)
![ws22](png/ping7.13.png)


## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

##### Запусти на r2 фаервол с правилами из Части 7.
Запускаем файл командами sudo chmod +x /etc/firewall.sh и sudo bash /etc/firewall.sh

##### Запусти веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* измени строку `Listen 80` на `Listen localhost:80`).
![Apache](png/ping8.1.png)

##### Воспользуйся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.
![Local TCP forwarding](png/ping8.3.png)

##### Воспользуйся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.
![Remote TCP forwarding](png/ping8.4.png)

##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейди во второй терминал (например, клавишами Alt + F2) и выполни команду:
`telnet 127.0.0.1 [локальный порт]`
![ws22](png/ping8.6.png)
